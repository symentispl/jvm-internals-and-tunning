= Are you fast enough?
:idprefix:
:stem: asciimath
:backend: html
:source-highlighter: highlightjs
:highlightjs-style: github
:revealjs_history: true
:revealjs_theme: night
:revealjs_controls: false
:revealjs_width: 1920
:revealjs_height: 1080
:imagesdir: images
:customcss: css/custom.css
:sourcedir: ../../..

== about me

Neo4j (a graph database) performance engineer

over 20 years with JVM, +
since early days of no native threads and, +
no JIT and slow as hell GC

speaker, coder, architect

founder of SegFault conference

== DISCLAIMER

this presentation may contain strong language, my own opinions, references
to sex, drugs, religion, alcohol and politics

if this does make you feel offended that's good it means you have something you care about in your life

=== universal truth about performance

=== performance is hard!

=== performance is fun!

=== !

code

profile

analyze

=== let me introduce

"not invented here "map reduce framework +
& +
distinct word count, +
aka Hello World of map/reduce

=== !

"pure" JDK 11,

Java Microbenchmark Harness

Async profiler

Java Mission Control

flamegraphs

== naive implementation

single threaded

=== !

[role="stretch"]
[source,java,indent=0]
----
include::{sourcedir}/mapreduce-framework/src/main/java/pl/symentis/mapreduce/Input.java[]
----

=== !

[role="stretch"]
[source,java,indent=0]
----
include::{sourcedir}/mapreduce-framework/src/main/java/pl/symentis/mapreduce/Mapper.java[]]
----

=== !

[role="stretch"]
[source,java,indent=0]
----
include::{sourcedir}/mapreduce-framework/src/main/java/pl/symentis/mapreduce/Reducer.java[]]
----

=== !

[role="stretch"]
[source,java,indent=0]
----
include::{sourcedir}/mapreduce-framework/src/main/java/pl/symentis/mapreduce/Output.java[]]
----

=== !

[role="stretch"]
[source,java,indent=0]
----
include::{sourcedir}/mapreduce-framework/src/main/java/pl/symentis/mapreduce/SequentialMapReduce.java[lines=51..65]
----

=== is it fast enough?

=== !

[role="stretch"]
[source,java,indent=0]
----
include::{sourcedir}/mapreduce-perf/src/main/java/pl/symentis/wordcount/SequentialMapReduceWordCountBenchmark.java[lines=19..59]
----
=== !

[format="csv", options="header"]
|===
Benchmark,Mode,Score,Unit
Sequential,"thrpt",1.830915,ops/s
|===

=== is it fast enough?

=== !

image::SequentialMapReduceWordCountBenchmark-NonThreadLocalStopwords.svg[background, size=contain]

=== !

[role="stretch"]
[source,java,indent=0]
----
include::{sourcedir}/mapreduce-wordcount/src/main/java/pl/symentis/wordcount/stopwords/NonThreadLocalStopwords.java[lines=13..38]
----

=== !

image::SequentialMapReduceWordCountBenchmark-ThreadLocalStopwords.svg[background, size=contain]

=== !

image::SequentialMapReduceWordCountBenchmark-ICUThreadLocalStopwords.svg[background, size=contain]

=== !

[role="stretch"]
[source,java,indent=0]
----
include::{sourcedir}/mapreduce-framework/src/main/java/pl/symentis/mapreduce/mapper/HashMapOutput.java[lines=17..26]
----

=== is it fast enough?

[format="csv", options="header"]
|===
Mapper,Mode,Score,Unit
HashMap,"thrpt",1.874043,ops/s
GuavaMultiMap,"thrpt",1.927683,ops/s
EclipseMultiMap,"thrpt",1.830915, ops/s
|===

=== !

[quote,Wes Dyer,"Immutability, Purity, and Referential Transparency"]
  Make it correct, make it clear, make it concise, make it fast.
  In that order.

=== is it fast enough?

=== threads !!!

image::https://media.giphy.com/media/XUVPMUlUNUAog/giphy.gif[background, size=contain]

=== !

never ever start with +
concurrent implementation first,

*just no*

if you cannot make single thread fast, +
why do you think you can do so for multiple threads

=== divide

[role="stretch"]
[source,java,indent=0]
----
include::{sourcedir}/mapreduce-framework/src/main/java/pl/symentis/mapreduce/ParallelMapReduce.java[lines=46..72]
----

=== conquer

[role="stretch"]
[source,java,indent=0]
----
include::{sourcedir}/mapreduce-framework/src/main/java/pl/symentis/mapreduce/ParallelMapReduce.java[lines=75..78]
----

=== is it fast enough?

[format="csv", options="header"]
|===
Benchmark,Mode,Score,Unit
Sequential,"thrpt",1.830915,ops/s
Parallel,"thrpt",2.895935,ops/s
|===

=== moar threads

// here csv

=== flight recorder

image::https://media.giphy.com/media/iJ5bSix01wY36/giphy.gif[background]

=== !

image::ParallelMapReduce-32-threads-jmc.png[background]

=== contention stupid

BlockingQueue in ThreadPool

ConcurrentHashMap

=== batching

send bigger chunks of data into ThreadPool

don't share ConcurrentHashMap +
(it will require additional phase)

=== !

[role="stretch"]
[source,java,indent=0]
----
include::{sourcedir}/mapreduce-framework/src/main/java/pl/symentis/mapreduce/BatchingParallelMapReduce.java[lines=72..90]
----

=== !

[role="stretch"]
[source,java,indent=0]
----
include::{sourcedir}/mapreduce-framework/src/main/java/pl/symentis/mapreduce/BatchingParallelMapReduce.java[lines=148..155]
----

=== !

[role="stretch"]
[source,java,indent=0]
----
include::{sourcedir}/mapreduce-framework/src/main/java/pl/symentis/mapreduce/BatchingParallelMapReduce.java[lines=109..121]
----

=== is it fast enough?

[format="csv", options="header"]
|===
Benchmark,Mode,Score,Unit
Sequential,"thrpt",1.830915,ops/s
Parallel,"thrpt",2.895935,ops/s
Batching,"thrpt",4.283660,ops/s
|===

=== !

image::https://media.giphy.com/media/OH2rL6DVTNpte/giphy.gif[background]

=== !

image::https://media.giphy.com/media/zSZogXiRS2zjG/giphy.gif[background]

=== ForkJoinPool

[role="stretch"]
[source,java,indent=0]
----
include::{sourcedir}/mapreduce-framework/src/main/java/pl/symentis/mapreduce/ForkJoinMapReduce.java[lines=47..75]
----

=== my eyes are bleeding

This was probably worst `RecursiveTask` implementation you have every seen,

blocking operation (use ManagedBlocking)

but?

=== is it fast enough?

[format="csv", options="header"]
|===
Benchmark,Mode,Score,Unit
Sequential,"thrpt",1.830915,ops/s
Parallel,"thrpt",2.895935,ops/s
Batching,"thrpt",4.283660,ops/s
ForkJoin,"thrpt",4.458359,ops/s
|===

=== are we done?

=== !

during tests we were using 6 Mb text file, +
guess what, +
it OOMs with 100 Mb file

=== !

intermediate results (from map phase) are kept in memory

=== ?

flush them to disk +
(serialization costs, oh so much fun)

start reduction as soon as we have first results from map +
(sacrifice threads, smaller throughput of map phase)

=== !

no animals were hurt, +
only random bytecodes +
which you can find at

https://bitbucket.org/symentis/fast-enough/[]

=== the end
